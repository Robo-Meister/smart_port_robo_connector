{
  "type": "workflow",
  "name": "Shipment Rebooking",
  "stages": [
    {
      "name": "trigger",
      "signals": [
        "ETA delayed or dock congested",
        "Carrier capacity shortfall",
        "Regulatory hold resolved"
      ]
    },
    {
      "name": "propose",
      "actions": [
        {
          "action_id": "rebooking.alternatives.search",
          "inputs": {
            "booking.shipment_id": "{booking.shipment_id}",
            "constraints": "{constraints}",
            "booking.slot_chain.stages": "{booking.slot_chain.stages}"
          },
          "actor_type": "operations"
        },
        {
          "action_id": "rebooking.slots.suggest",
          "inputs": {
            "booking.alternatives": "{booking.alternatives}",
            "policy.rebooking_auto_suggest": "policies/rebooking-auto-suggest.json",
            "booking.slot_chain_constraints": "{booking.slot_chain_constraints}",
            "policy.selection_strategy": "next_available_with_policy",
            "policy.max_suggestions": 3
          },
          "actor_type": "operations"
        },
        {
          "action_id": "rebooking.alternatives.rank",
          "inputs": {
            "booking.alternatives": "{booking.alternatives}",
            "policy.guardrail_policy": "policies/rebooking.json",
            "policy.cost_model": "{policy.cost_model}",
            "policy.sla_thresholds": "{policy.sla_thresholds}",
            "policy.ranking_weights": "{policy.ranking_weights}"
          },
          "actor_type": "operations"
        },
        {
          "action_id": "rebooking.alternatives.handle_insufficient",
          "inputs": {
            "booking.ranked_alternatives": "{booking.ranked_alternatives}",
            "policy.minimum_required": 3
          },
          "actor_type": "operations"
        },
        {
          "action_id": "rebooking.plan.assemble",
          "inputs": {
            "booking.shipment_id": "{booking.shipment_id}",
            "booking.top_3_alternatives": "{booking.top_3_alternatives}"
          },
          "actor_type": "operations"
        },
        {
          "action_id": "rebooking.guardrails.validate",
          "inputs": {
            "booking.rebooking_plan_id": "{booking.rebooking_plan_id}",
            "policy.guardrail_policy": "policies/rebooking.json"
          },
          "actor_type": "compliance"
        },
        {
          "action_id": "rebooking.preview.generate",
          "inputs": {
            "booking.shipment_id": "{booking.shipment_id}",
            "booking.rebooking_plan_id": "{booking.rebooking_plan_id}",
            "policy.cost_model": "{policy.cost_model}"
          },
          "actor_type": "operations"
        }
      ],
      "what_if_preview_schema": {
        "eta_impact": {
          "previous_eta": "ISO-8601 datetime",
          "proposed_eta": "ISO-8601 datetime",
          "delta_hours": "number"
        },
        "cost_impact": {
          "currency": "ISO-4217",
          "base_cost": "number",
          "proposed_cost": "number",
          "delta_cost": "number"
        },
        "sla_risk": {
          "risk_level": "low|medium|high",
          "breach_probability": "number",
          "notes": "string"
        }
      }
    },
    {
      "name": "approve",
      "actions": [
        {
          "action_id": "approval.operations.route",
          "inputs": {
            "booking.rebooking_plan_id": "{booking.rebooking_plan_id}",
            "policy.approver_group": "{policy.approver_group}"
          },
          "actor_type": "operations"
        },
        {
          "action_id": "rebooking.guardrails.validate",
          "inputs": {
            "booking.rebooking_plan_id": "{booking.rebooking_plan_id}",
            "policy.guardrail_policy": "{policy.guardrail_policy}"
          },
          "actor_type": "compliance"
        },
        {
          "action_id": "approval.destination_change.capture",
          "inputs": {
            "booking.shipment_id": "{booking.shipment_id}",
            "booking.destination_change": "{booking.destination_change}",
            "policy.approver": "{policy.approver}"
          },
          "actor_type": "customer_success"
        }
      ],
      "policy_reference": "policies/rebooking.json"
    },
    {
      "name": "execute",
      "actions": [
        {
          "action_id": "eta.update",
          "inputs": {
            "booking.shipment_id": "{booking.shipment_id}",
            "booking.new_eta": "{booking.new_eta}"
          },
          "actor_type": "operations"
        },
        {
          "action_id": "slot.chain.confirm",
          "inputs": {
            "booking.slot_chain.slot_chain_id": "{booking.slot_chain.slot_chain_id}",
            "booking.requested_window": "{booking.requested_window}"
          },
          "actor_type": "port_ops"
        },
        {
          "action_id": "notifications.send",
          "inputs": {
            "booking.shipment_id": "{booking.shipment_id}",
            "policy.notification_channels": "{policy.notification_channels}"
          },
          "actor_type": "customer_success"
        }
      ],
      "rollback": {
        "on_failure": "Revert to last confirmed plan",
        "status": "execution_failed"
      }
    }
  ],
  "partial_failure_scenarios": [
    {
      "scenario": "Slot chain confirmed but ETA update fails",
      "signals": [
        "slot_chain_confirmed",
        "eta_update_failed"
      ],
      "impact": "Rebooking executed without updated customer ETA",
      "resolution_path": "eta_update_recovery"
    },
    {
      "scenario": "Approval granted but rebooking execution fails",
      "signals": [
        "approval_granted",
        "execution_failed"
      ],
      "impact": "Approved plan not applied",
      "resolution_path": "execution_recovery"
    }
  ],
  "resolution_paths": {
    "eta_update_recovery": {
      "actions": [
        "Retry ETA update with backoff",
        "Notify customer success of stale ETA",
        "Publish manual ETA override"
      ],
      "fallback": "Add customer-facing warning banner",
      "owner": "Customer Success"
    },
    "execution_recovery": {
      "actions": [
        "Invoke rollback to last confirmed plan",
        "Re-run slot confirmation",
        "Escalate to operations for manual rebooking"
      ],
      "fallback": "Hold original booking",
      "owner": "Port Ops"
    }
  },
  "concurrency_locks": [
    {
      "resource": "container_move",
      "scope": "container_id",
      "lock_key": "container:{container_id}:move",
      "held_during_stages": [
        "propose",
        "approve",
        "execute"
      ],
      "release_conditions": [
        "rebooking_confirmed",
        "rollback_completed"
      ]
    }
  ],
  "policy_references": {
    "resilience": "policies/resilience.json",
    "rebooking_guardrails": "policies/rebooking.json",
    "rebooking_auto_suggest": "policies/rebooking-auto-suggest.json"
  }
}
