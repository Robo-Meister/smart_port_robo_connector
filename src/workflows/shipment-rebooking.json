{
  "type": "workflow",
  "name": "Shipment Rebooking",
  "stages": [
    {
      "name": "trigger",
      "signals": [
        "ETA delayed or dock congested",
        "Carrier capacity shortfall",
        "Regulatory hold resolved"
      ]
    },
    {
      "name": "propose",
      "actions": [
        {
          "action_id": "show_alternative_ports_or_slot_chains",
          "inputs": {
            "shipment_id": "{shipment_id}",
            "constraints": "{constraints}",
            "preferred_ports": "{preferred_ports}",
            "required_resources": [
              "gate",
              "yard",
              "crane",
              "berth"
            ]
          },
          "actor_type": "operations"
        },
        {
          "action_id": "validate_rebooking_guardrails",
          "inputs": {
            "alternatives": "{alternatives}",
            "guardrail_policy": "policies/rebooking.json",
            "shipment_value": "{shipment_value}"
          },
          "actor_type": "compliance"
        },
        {
          "action_id": "generate_what_if_preview",
          "inputs": {
            "shipment_id": "{shipment_id}",
            "alternatives": "{allowed_alternatives}",
            "cost_model": "{cost_model}",
            "batch_mode": "per_alternative",
            "enrich_field": "what_if_preview"
          },
          "actor_type": "operations"
        },
        {
          "action_id": "rank_rebooking_alternatives",
          "inputs": {
            "alternatives": "{enriched_alternatives}",
            "guardrail_policy": "policies/rebooking.json",
            "cost_model": "{cost_model}",
            "sla_thresholds": "{sla_thresholds}",
            "ranking_weights": "{ranking_weights}"
          },
          "actor_type": "operations"
        },
        {
          "action_id": "handle_insufficient_rebooking_alternatives",
          "inputs": {
            "ranked_alternatives": "{ranked_alternatives}",
            "minimum_required": 3,
            "disallowed_reasons": "{disallowed_reasons}",
            "fallback_strategy": "return_fewer_with_reasons"
          },
          "actor_type": "operations"
        },
        {
          "action_id": "assemble_candidate_rebooking_plan",
          "inputs": {
            "shipment_id": "{shipment_id}",
            "top_3_alternatives": "{top_3_or_fewer_alternatives}",
            "plan_constraints": "{plan_constraints}",
            "slot_chain_constraints": "{slot_chain_constraints}"
          },
          "actor_type": "operations"
        }
      ],
      "what_if_preview_schema": {
        "eta_impact": {
          "previous_eta": "ISO-8601 datetime",
          "proposed_eta": "ISO-8601 datetime",
          "delta_hours": "number"
        },
        "cost_impact": {
          "currency": "ISO-4217",
          "base_cost": "number",
          "proposed_cost": "number",
          "delta_cost": "number"
        },
        "sla_risk": {
          "risk_level": "low|medium|high",
          "breach_probability": "number",
          "notes": "string"
        }
      }
    },
    {
      "name": "approve",
      "actions": [
        {
          "action_id": "route_for_operations_approval",
          "inputs": {
            "rebooking_plan_id": "{rebooking_plan_id}",
            "approver_group": "{approver_group}",
            "urgency": "{urgency}"
          },
          "actor_type": "operations"
        },
        {
          "action_id": "validate_rebooking_guardrails",
          "inputs": {
            "rebooking_plan_id": "{rebooking_plan_id}",
            "guardrail_policy": "{guardrail_policy}",
            "shipment_value": "{shipment_value}"
          },
          "actor_type": "compliance"
        },
        {
          "action_id": "capture_destination_change_approval",
          "inputs": {
            "shipment_id": "{shipment_id}",
            "destination_change": "{destination_change}",
            "approver": "{approver}"
          },
          "actor_type": "customer_success"
        }
      ],
      "policy_reference": "policies/rebooking.json"
    },
    {
      "name": "execute",
      "actions": [
        {
          "action_id": "update_etas",
          "inputs": {
            "shipment_id": "{shipment_id}",
            "new_eta": "{new_eta}",
            "reason": "{reason}"
          },
          "actor_type": "operations"
        },
        {
          "action_id": "confirm_slot_chain",
          "inputs": {
            "slot_chain_request_id": "{slot_chain_request_id}",
            "container_id": "{container_id}",
            "requested_window": "{requested_window}",
            "dependency_rules": "{dependency_rules}"
          },
          "actor_type": "port_ops"
        },
        {
          "action_id": "notify_stakeholders",
          "inputs": {
            "shipment_id": "{shipment_id}",
            "notification_channels": "{notification_channels}",
            "message_template": "{message_template}"
          },
          "actor_type": "customer_success"
        }
      ],
      "rollback": {
        "on_failure": "Revert to last confirmed plan",
        "status": "execution_failed"
      }
    }
  ],
  "partial_failure_scenarios": [
    {
      "scenario": "Slot chain confirmed but ETA update fails",
      "signals": [
        "slot_chain_confirmed",
        "eta_update_failed"
      ],
      "impact": "Rebooking executed without updated customer ETA",
      "resolution_path": "eta_update_recovery"
    },
    {
      "scenario": "Approval granted but rebooking execution fails",
      "signals": [
        "approval_granted",
        "execution_failed"
      ],
      "impact": "Approved plan not applied",
      "resolution_path": "execution_recovery"
    }
  ],
  "resolution_paths": {
    "eta_update_recovery": {
      "actions": [
        "Retry ETA update with backoff",
        "Notify customer success of stale ETA",
        "Publish manual ETA override"
      ],
      "fallback": "Add customer-facing warning banner",
      "owner": "Customer Success"
    },
    "execution_recovery": {
      "actions": [
        "Invoke rollback to last confirmed plan",
        "Re-run slot confirmation",
        "Escalate to operations for manual rebooking"
      ],
      "fallback": "Hold original booking",
      "owner": "Port Ops"
    }
  },
  "concurrency_locks": [
    {
      "resource": "container_move",
      "scope": "container_id",
      "lock_key": "container:{container_id}:move",
      "held_during_stages": [
        "propose",
        "approve",
        "execute"
      ],
      "release_conditions": [
        "rebooking_confirmed",
        "rollback_completed"
      ]
    }
  ],
  "policy_references": {
    "resilience": "policies/resilience.json",
    "rebooking_guardrails": "policies/rebooking.json",
    "rebooking_auto_suggest": "policies/rebooking-auto-suggest.json"
  }
}
